# ?? Handlebars Context Analysis - What's Happening vs. What You Expected

## ?? **Current Data Flow:**

```
???????????????????????????????????????????????????????????????????
? DATABASE VIEWS                                                   ?
???????????????????????????????????????????????????????????????????
?                                                                  ?
? 1. view_categories                                              ?
?    ?? categoryId                                                ?
?    ?? categoryName                                              ?
?    ?? categoryDescription                                       ?
?                                                                  ?
? 2. view_spell_categorization                                    ?
?    ?? categoryName                                              ?
?    ?? spellName                                                 ?
?    ?? rank                                                      ?
?                                                                  ?
? 3. view_spell_details_by_category ? (THIS IS BEING USED)      ?
?    ?? categoryId                                                ?
?    ?? categoryName                                              ?
?    ?? id                                                        ?
?    ?? spellName                                                 ?
?    ?? archiveURL                                                ?
?    ?? rank                                                      ?
?    ?? traits                                                    ?
?    ?? actions                                                   ?
?    ?? spellTarget                                               ?
?    ?? spellRange ? (Available)                                 ?
?    ?? area ? (Available)                                       ?
?    ?? duration ? (Available)                                   ?
?    ?? defense ? (Available)                                    ?
?    ?? rarity                                                    ?
?    ?? summary                                                   ?
?    ?? spoilers                                                  ?
?    ?? source                                                    ?
?    ?? heighten ? (Available)                                   ?
?                                                                  ?
???????????????????????????????????????????????????????????????????
                              ?
???????????????????????????????????????????????????????????????????
? illusionCallbacks.js - getIllusionPage()                        ?
???????????????????????????????????????????????????????????????????
?                                                                  ?
? Query 1: SELECT * FROM view_categories                          ?
?   ? Stores in: context.view_categories                          ?
?                                                                  ?
? Query 2: SELECT * FROM view_spell_details_by_category           ?
?   ? Uses to build: context.categories[]                         ?
?                                                                  ?
? TRANSFORMATION:                                                  ?
? Takes view_spell_details_by_category rows and groups them:      ?
?                                                                  ?
? context.categories = [                                          ?
?   {                                                             ?
?     categoryId: 1,                                              ?
?     categoryName: "Subtle Spells",                              ?
?     categoryDescription: "Spells that are difficult...",        ?
?     spells: [                                                   ?
?       {                                                         ?
?         id: 8,                                                  ?
?         spellName: "Burglar's Blind",                           ?
?         archiveURL: "https://...",                              ?
?         rank: 3,                                                ?
?         traits: "Illusion, Manipulate, Rare, Subtle",           ?
?         actions: "Two Actions",                                 ?
?         spellTarget: "1 willing creature",                      ?
?         spellRange: "60 feet", ?                                ?
?         area: null,                                             ?
?         duration: "sustained up to 10 minutes", ?              ?
?         defense: "", ?                                          ?
?         rarity: "Rare",                                         ?
?         summary: "The only thing thieves...",                   ?
?         spoilers: "",                                           ?
?         source: "NPC Core pg. 26",                              ?
?         heighten: "" ?                                          ?
?       },                                                        ?
?       // ... more spells                                        ?
?     ]                                                           ?
?   },                                                            ?
?   // ... more categories                                        ?
? ]                                                               ?
?                                                                  ?
???????????????????????????????????????????????????????????????????
                              ?
???????????????????????????????????????????????????????????????????
? illusion.js Router                                              ?
???????????????????????????????????????????????????????????????????
?                                                                  ?
? res.render('illusions', {                                       ?
?     layout: null,                                               ?
?     categories: context.categories ?                           ?
? });                                                             ?
?                                                                  ?
? PASSED TO TEMPLATE:                                             ?
? - categories array (with all spell fields including range,      ?
?   duration, defense, heighten)                                  ?
?                                                                  ?
???????????????????????????????????????????????????????????????????
                              ?
???????????????????????????????????????????????????????????????????
? views/illusions.handlebars                                      ?
???????????????????????????????????????????????????????????????????
?                                                                  ?
? {{#each categories}}                                            ?
?   <details>                                                     ?
?     <summary>{{this.categoryName}}</summary>                    ?
?                                                                  ?
?     {{#each this.spells}} ?                                    ?
?       <div class="spell-entry">                                 ?
?         <a href="{{this.archiveURL}}">                          ?
?           {{this.spellName}}                                    ?
?         </a>                                                    ?
?         <span>Rank {{this.rank}}</span>                         ?
?       </div>                                                    ?
?     {{/each}}                                                   ?
?   </details>                                                    ?
? {{/each}}                                                       ?
?                                                                  ?
? CONTEXT AVAILABLE IN {{this.spells}}:                           ?
? - ? spellRange                                                 ?
? - ? spellTarget                                                ?
? - ? area                                                       ?
? - ? duration                                                   ?
? - ? defense                                                    ?
? - ? heighten                                                   ?
?                                                                  ?
? BUT CURRENTLY NOT DISPLAYED! ??                                 ?
?                                                                  ?
???????????????????????????????????????????????????????????????????
                              ?
???????????????????????????????????????????????????????????????????
? views/partials/spell_entry.hbs (NOT CURRENTLY USED!)           ?
???????????????????????????????????????????????????????????????????
?                                                                  ?
? This partial EXISTS but is NEVER INCLUDED                       ?
?                                                                  ?
? It expects:                                                     ?
? - {{this.spellRange}}  ? Available in context                 ?
? - {{this.spellTarget}} ? Available in context                 ?
? - {{this.area}}        ? Available in context                 ?
? - {{this.duration}}    ? Available in context                 ?
? - {{this.defense}}     ? Available in context                 ?
? - {{this.heighten}}    ? Available in context                 ?
?                                                                  ?
? If you USED this partial, you would see "Rank blabla {{rank}}" ?
?                                                                  ?
???????????????????????????????????????????????????????????????????
```

---

## ?? **THE PROBLEM:**

### **What's Happening:**
1. ? Data is correctly loaded from `view_spell_details_by_category`
2. ? Data includes all fields: spellRange, duration, defense, heighten, etc.
3. ? Data is properly passed to the template as `context.categories`
4. ? **BUT:** `illusions.handlebars` has inline spell rendering
5. ? **AND:** `spell_entry.hbs` partial exists but is **NEVER USED**

### **Current Template Structure:**
```handlebars
<!-- illusions.handlebars -->
{{#each categories}}
  <details>
    <summary>{{this.categoryName}}</summary>
    
    {{#each this.spells}}
      <!-- INLINE RENDERING - not using partial -->
      <div class="spell-entry">
        <a href="{{this.archiveURL}}">{{this.spellName}}</a>
        <span>Rank {{this.rank}}</span>
        <!-- ?? OTHER FIELDS NOT DISPLAYED -->
      </div>
    {{/each}}
  </details>
{{/each}}
```

### **What You Expected (with spell_entry partial):**
```handlebars
<!-- illusions.handlebars -->
{{#each categories}}
  <details>
    <summary>{{this.categoryName}}</summary>
    
    {{#each this.spells}}
      {{> spell_entry}} <!-- USE THE PARTIAL -->
    {{/each}}
  </details>
{{/each}}
```

---

## ? **THE SOLUTION:**

### **Option 1: Use the Partial (Recommended)**

Replace the inline spell rendering with your partial:

```handlebars
{{#each this.spells}}
  {{> spell_entry}}
{{/each}}
```

### **Option 2: Add Fields to Existing Inline Rendering**

If you want to keep it inline, add the missing fields:

```handlebars
<div class="spell-entry">
  <a href="{{this.archiveURL}}">{{this.spellName}}</a>
  <span class="inline-green-tag">
    Rank {{this.rank}}
    {{#if this.spellRange}} | Range: {{this.spellRange}}{{/if}}
    {{#if this.duration}} | Duration: {{this.duration}}{{/if}}
    <!-- etc -->
  </span>
</div>
```

---

## ?? **Summary:**

| Item | Status | Notes |
|------|--------|-------|
| `view_spell_details_by_category` | ? Being queried | Correct view, all fields present |
| Data in context | ? Complete | All fields available (range, duration, etc.) |
| `spell_entry.hbs` partial | ?? Exists but unused | Ready to use, just not included |
| `illusions.handlebars` | ?? Inline rendering | Doesn't use partial, missing fields |
| String "blabla" | ? In partial only | Would show if partial was used |

**The data IS there, you're just not displaying it!**

---

## ?? **Next Step:**

Tell me which option you prefer:
1. Use the `spell_entry` partial (cleaner, reusable)
2. Update the inline rendering in `illusions.handlebars`

I'll make the changes for you! ??
